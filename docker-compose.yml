name: ${STACK_NAME:-coedit}

services:
  nginx:
    image: nginx:1.27-alpine
    depends_on:
      web:
        condition: service_healthy
      server:
        condition: service_healthy
    ports:
      - "8000:8000"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    environment:
      - APP_DOMAIN=${APP_DOMAIN:-coedit.local}
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
      target: dev
    env_file:
      - .env
    volumes:
      - ./web:/workspace
      - web-node-modules:/workspace/node_modules
    environment:
      - APP_ENV=${APP_ENV:-dev}
      - NEXT_PUBLIC_APP_NAME=${APP_NAME:-coedit}
      - NEXT_PUBLIC_APP_DOMAIN=${APP_DOMAIN:-localhost}
      - NEXT_PUBLIC_BASE_URL=${APP_BASE_URL:-}
      - NEXT_PUBLIC_STORAGE_PREFIX=${APP_STORAGE_PREFIX:-coedit}
    expose: ["3000"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/ >/dev/null || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 60s
    restart: unless-stopped

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: dev
    env_file:
      - .env
    environment:
      - RUST_LOG=info
      - DATA_DIR=/vault
      - FLUSH_IDLE_MS=1500
      - FLUSH_MAX_OPS=200
      - LOCAL_UID=${LOCAL_UID:-1000}
      - LOCAL_GID=${LOCAL_GID:-1000}
      - APP_DOMAIN=${APP_DOMAIN:-localhost}
      - APP_ALLOWED_ORIGINS=${APP_ALLOWED_ORIGINS:-}
    volumes:
      - ${VAULT_HOST_PATH:-./vault}:/vault
      - ./server:/workspace
      - cargo-target:/workspace/target
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
    expose: ["9000"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9000/api/health | grep -q '^ok$'"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 60s
    restart: unless-stopped

volumes:
  web-node-modules:
  cargo-target:
  cargo-registry:
  cargo-git:
