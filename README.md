# coedit

coedit は、複数人が並行して編集できる Markdown ドキュメント共同編集アプリケーションです。
リアルタイム同期・Markdown レンダリング付きの編集ページと閲覧ページを備え、チームの議事録や仕様書などのドキュメントの共同編集と共有を可能とします。

実際に動作しているアプリが以下のURLにあります。
https://docs.asuto.dev

## 本リポジトリについて
本リポジトリは、驚額の殿堂発行の技術同人誌「フランクフルト」のvol.1に寄稿した「OTから実装するドキュメント共同編集アプリ」という記事のサンプル実装となっています。
詳細な実装は記事を書いた時と少し異なるものの、基本的な仕組みは記事で解説した通りに動作しています。

記事本体に誤字脱字や内容の訂正があれば、以下のURLに訂正表を掲示いたします。
https://storage.asuto.dev/kyogaku-dendo/error-corrections.md

## 特徴
- **リアルタイムで共同編集**
    - カーソル位置や参加メンバーの Presence を同期し、誰がどこを編集中か一目で把握できます。
- **履歴とスナップショット管理**
    - サーバが WAL / スナップショットを保持し、自動保存と復旧をサポートします。
- **柔軟なアクセスコントロール**
    - URL 単位のパスワード保護や共有リンク制御で安全にドキュメントを公開できます。
- **分割ビューのライブプレビュー**
    - Markdown を編集しながら常にプレビューを確認できます。
- **URL ベースの整理**
    - 任意のパスをドキュメント ID に利用でき、チーム・プロジェクト単位で体系的に整理できます。

## アプリケーションの使い方

1. トップページでドキュメント ID（`team/project-note` などのパス）を入力します。
2. `編集ページを開く` を押すと該当ドキュメントの編集ページを開きます。存在しない場合は新規作成されます。
3. `閲覧ページを開く` を押すと同じドキュメントの閲覧専用ビューに切り替わります。
4. 編集ページのツールバーから閲覧用パスワードを設定・更新すると、編集・閲覧ページへのアクセス時にパスワード認証が要求されます。
5. 編集ページのツールバーからEditor, Both, Previewを切り替えることで、ドキュメントの編集とMarkdownの表示のそれぞれもしくは両方を画面に表示できます。
6. 表示名とカーソルカラーをカスタマイズして保存することで、他のクライアントからの見た目を変更できます。

## システム構成

| コンテナ | 技術スタック | 役割 |
|----------|--------------|------|
| `web`    | Next.js (App Router, Yarn 4) | フロントエンド UI（編集／閲覧ページ、リアルタイム同期 UI） |
| `server` | Rust (axum, edition 2024)    | 編集用 API、WebSocket、WAL / スナップショット管理 |
| `nginx`  | NGINX                           | 80/443 のフロント、`/` → web:3000、`/api/` → server:9000 へリバースプロキシ |

Docker Compose で上記のコンテナを同時に起動します。

## セットアップ

### 必要条件

- Docker および Docker Compose
- GNU Make
- （任意）Node.js 18 以降 / Rust 1.80 以降（直接実行する場合）

### 初回設定

1. `.env.example` を `.env` にコピーし、`APP_DOMAIN` を環境に合わせて設定します。必要に応じて `VAULT_HOST_PATH` でホスト側永続ディレクトリを指定します。
2. リポジトリ直下で以下を実行し、コンテナ群を起動します。

   ```bash
   make up
   ```

3. `http://localhost`（Cloudflare/Tailscale 等で終端する場合はそれぞれの URL）へアクセスしてアプリケーションを確認します。

### 停止・ログ

- 停止: `make down`
- ログ確認: `make logs`

## 開発ワークフロー

- フロントエンドの開発:
  - `make web-shell` → コンテナ内 `/workspace` に入ったのち `yarn dev`
- サーバ（Rust）のホットリロード:
  - `make server-shell` → `/workspace` で `cargo watch -x run`
- テスト:
  - Rust: `make test`（= `cargo test`）
- フォーマット:
  - Rust: `make fmt`
- リント:
  - TypeScript: `make lint`

ホスト側で直接実行したい場合は、`web/` で `yarn install` 後に `yarn dev`、`server/` で `cargo run` 等を実行してください。

## ディレクトリ構成

```
.
├── web/                # Next.js アプリケーション
├── server/             # Rust (axum) サーバ
├── nginx/              # NGINX リバースプロキシの設定
├── docker-compose.yml  # サービス定義
├── vault/              # WAL / スナップショット保管用（コミット対象外）
└── Makefile            # 開発用コマンド
```

## 環境変数の解説

- `APP_DOMAIN`: アプリケーションの公開ドメイン。未設定時は `localhost`。
- `APP_BASE_URL` / `APP_ALLOWED_ORIGINS`: 空の場合は `APP_DOMAIN` から自動推定。
- `VAULT_HOST_PATH`: WAL / スナップショットをホストの任意ディレクトリへバインドしたい場合に設定。
- `LOCAL_UID` / `LOCAL_GID`: コンテナ内ユーザー ID をホストに合わせたい場合に使用。
